# ===================================
# PARHELION CI - Build & Test Pipeline
# Se ejecuta en cada push/PR a develop y main
# v0.4.3: Agregado PostgreSQL service para tests de integracion
# ===================================

name: CI Pipeline

on:
  push:
    branches: [develop, main]
  pull_request:
    branches: [develop, main]

jobs:
  # ===== BACKEND (.NET 8) + PostgreSQL Tests =====
  backend:
    name: Backend Build & Integration Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend

    # PostgreSQL service para tests de integracion reales
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: parhelion_test
          POSTGRES_PASSWORD: test_password_ci
          POSTGRES_DB: parhelion_test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      # Connection string para tests con PostgreSQL real
      ConnectionStrings__DefaultConnection: "Host=localhost;Port=5432;Database=parhelion_test_db;Username=parhelion_test;Password=test_password_ci"

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --configuration Release --no-restore

      # Tests de integracion con InMemory DB (rapidos, no requieren DB real)
      - name: Run Integration Tests (InMemory)
        run: dotnet test --configuration Release --no-build --verbosity normal --logger "trx;LogFileName=test-results.trx"

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: backend/tests/**/test-results.trx

      # Validar que las migraciones se aplican correctamente a PostgreSQL
      - name: Install EF Core Tools
        run: dotnet tool install --global dotnet-ef

      - name: Apply Migrations to PostgreSQL
        run: dotnet ef database update --project src/Parhelion.Infrastructure --startup-project src/Parhelion.API
        env:
          ASPNETCORE_ENVIRONMENT: Testing

      - name: Verify Database Schema
        run: |
          echo "Verificando que todas las tablas existen en PostgreSQL..."
          PGPASSWORD=test_password_ci psql -h localhost -U parhelion_test -d parhelion_test_db -c "\dt" | grep -E "(Tenants|Users|Employees|Shifts|Drivers|Trucks|Locations|Shipments)" && echo "Schema validation passed"

  # ===== FRONTEND ADMIN (Angular) =====
  frontend-admin:
    name: Admin Build & Lint
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend-admin

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "./frontend-admin/package-lock.json"

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint || true

      - name: Build
        run: npm run build

  # ===== FRONTEND OPERACIONES (React) =====
  frontend-operaciones:
    name: Operaciones Build & Lint
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend-operaciones

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "./frontend-operaciones/package-lock.json"

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint || true

      - name: Build
        run: npm run build

  # ===== FRONTEND CAMPO (React) =====
  frontend-campo:
    name: Campo Build & Lint
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend-campo

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "./frontend-campo/package-lock.json"

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint || true

      - name: Build
        run: npm run build

  # ===== DOCKER BUILD TEST =====
  docker:
    name: Docker Compose Validation
    runs-on: ubuntu-latest
    needs: [backend, frontend-admin, frontend-operaciones, frontend-campo]

    steps:
      - uses: actions/checkout@v4

      - name: Validate docker-compose
        run: docker compose config

      - name: Build all images
        run: docker compose build

  # ===== RESUMEN FINAL =====
  summary:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [docker]
    if: success()

    steps:
      - name: Success
        run: echo "Todos los builds, tests y validacion de DB pasaron correctamente"
